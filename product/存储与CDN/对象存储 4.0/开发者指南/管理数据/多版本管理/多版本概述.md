## 多版本
多版本是实现相同存储桶中存放同一对象多个版本的方法。例如，在一个存储桶中，您可以存放多个相同对象键为 123.txt 的对象，但其版本 Id 不同，例如 100000、100101 和 120002 等。用户对某一存储桶开启多版本功能后，可以根据版本 Id 检索、删除或还原存放在存储桶中的对象。这有助于恢复被用户误删或应用程序故障而丢失的数据。例如，用户在对多版本的对象进行删除操作时：

- 如果需要删除对象 （非完全删除），对象存储 COS 会为被删除的对象插入删除标记，该标记将作为当前对象版本，您可以根据 **删除标记** 恢复以前的版本。
- 如果需要替换对象，对象存储会为被添加对象插入新的版本 Id，您仍然可以根据版本 Id 恢复被替换前的对象。

## 多版本状态
存储桶可处于三种多版本状态：未启用多版本状态、启用多版本状态和暂停多版本状态。
- **未启用多版本状态：**指存储桶的默认初始状态，此时多版本功能关闭。
- **启用多版本状态：**指开启存储桶多版本功能，此时为多版本开启状态，多版本状态将应用到该存储桶中的 **所有对象**。您对存储桶首次启用多版本后，该存储桶中新添加的对象将拥有唯一的版本 ID。
- **暂停多版本状态：**指存储桶的多版本由开启状态变为暂停状态（无法返回未启用多版本状态），此后往存储桶中添加的对象将不再存放多版本的对象。

>**注意：**
>1. 一旦您对存储桶启用了多版本，它将无法返回到未启用多版本状态（初始状态）。但是，您可以对该存储桶暂停多版本，以便停止添加对象多版本。
>2. 在启用多版本之前，存储在存储桶中的对象具有版本 ID 为 null。
>3. 启用或暂停多版本时，会改变对象存储在处理这些对象的请求方式，不会改变对象本身。
>4. 只有根账号和授权子账号可以暂停存储桶的多版本。

## 管理多版本状态下的对象

在多版本状态下的对象包括三大类：未启用多版本、启用多版本和暂停多版本。您可以对这三大类别下的对象进行添加、检索和删除。除了未启用多版本，其他两大类检索对象和删除对象还包括有不指定版本 ID 和指定版本 ID。

- 未启用多版本状态下：添加、检索和删除对象等操作方式不变，详情请参阅 [上传对象](https://cloud.tencent.com/document/product/436/14113)。
- 启用和暂停多版本状态下：添加、检索和删除对象等操作方式，与以往方式的差别在于引入了版本 ID。其中执行删除对象操作还有“删除标记”的概念。


### 管理启用多版本状态下的对象
启用存储桶多版本前，已存储在存储桶中的对象，其版本 ID 为 null。启用多版本后，不会改变存储桶中的现有对象本身，只会改变对象存储对现有对象的处理方式（如请求方式）。对于新添加的对象，存储桶会开始存放对象版本。以下将介绍在已启用多版本的存储桶中如何管理对象：

>**注意：**用户在未启用多版本和启用多版本的存储桶中添加对象的方式都是相同的，但其版本 ID 不同。通过第二种方式，对象存储会为对象分配特定版本 ID，而前一种方式添加的对象，其版本 ID 始终为 null。

#### 添加对象

对存储桶启用多版本后，当用户执行 PUT、POST 或 COPY 操作时，对象存储 COS 会为存放到该存储桶中的对象自动添加唯一的版本 ID。
如下图所示，在启用了多版本的存储桶中添加对象时，对象存储为该对象添加唯一的版本 ID。

![](https://main.qcloudimg.com/raw/b51243cc5ea64e84635e94236f2bd09c.png)

#### 列出多版本对象

此部分提供从启用多版本的存储桶列出对象版本的示例。对象存储 在与存储桶关联的 versions 子资源中存储对象版本信息。对象存储 COS 按照存储顺序返回对象版本，最先返回最近存储的版本。

#### 检索特定对象的所有版本

您可以通过以下过程，使用 versions 子资源和 prefix 请求参数检索某对象的所有版本。有关 prefix 的更多信息，请参阅 GET Bucket。
检索键的所有版本，请求语法如下：
```
GET /?versions&prefix=objectName HTTP/1.1
```

#### 检索数据元版本

用户使用 GET 请求时无指定版本 ID，将检索对象的当前版本。如下图所示，GET 请求将返回 123.txt 对象的当前版本（最近版本）。

![](https://main.qcloudimg.com/raw/de38f23343cc247a792d8114474225c2.png)

如用户使用 GET 请求时指定其版本 ID，将检索指定版本 ID 的对象。如下图所示，GET versionId 请求检索指定版本（可以是当前版本）的对象。

![](https://main.qcloudimg.com/raw/3810d1610265ebb4a9f4c326b1b8dc10.png)


#### 检索对象版本的元数据
如果您只需检索对象的元数据（而不是其内容），您可以使用 HEAD 操作。默认情况下，您将获得最新版本的元数据。如要检索指定对象版本的元数据，则发送请求时需要指定其版本 ID。
检索指定版本的对象的元数据步骤如下：
- 将 versionId 配置为被检索对象元数据的版本 ID。
- 发送 HEAD 操作 versionId 请求。

#### 删除对象
您可以根据需要，随时删除不必要的对象版本。用户在已启用多版本状态下，使用 DELETE 请求有以下两个场景：

1. 用户未指定版本 ID，执行一般 DELETE 操作。

此操作场景类似于将被删除对象放到了“回收站”，但没有完全移除对象，后续用户如有需要仍然可以恢复数据。
如下图所示，用户在 DELETE 操作时不指定版本 ID，实际上不会删除 Key=123.txt 的对象，而是插入一个新的删除标记，并添加新的版本 ID。

![](https://main.qcloudimg.com/raw/d84083ebc73053ca29fd5503d79ff750.png)

>**注意：**对象存储 COS 将在存储桶中为被删除对象插入一个拥有新版本 ID 的删除标记，该删除标记将成为被删除对象的当前版本。当您尝试对该删除标记的对象执行 GET 操作时，对象存储会认为该对象不存在，并返回 404 错误。

2.用户指定版本 ID，执行操作 DELETE Object versionId，此场景可以永久删除多版本的对象。

![](https://main.qcloudimg.com/raw/3866ea99b80cfcee5daa8375d61fdd06.png)

#### 删除标记
删除标记用于多版本的对象，删除标记在对象存储 COS 中可认为是“对象已被删除”的标记。删除标记与对象同样拥有对象键（Key）和版本 ID。区别在于以下几点：
- 删除标记的内容为空。
- 删除标记不存在 ACL 值。
- 删除标记执行 GET 请求会返回 404 错误。
>响应返回如下：
>404 (Object not found) 错误
>响应标头 x-cos-delete-marker: true
- 删除标记只支持 DELETE 操作（需要根账号下发出请求）

#### 删除“删除标记”
用户如需删除“删除标记”，则可以在 DELETE Object versionId 请求中指定它的版本 ID，实现永久删除“删除标记”。如果您未指定删除标记的版本 ID，对删除标记发出 DELETE 请求，对象存储 COS 将不会删除该删除标记，而是再插入一个新的删除标记。
如下图所示，对删除标记执行一般 DELETE 请求，不会删除任何内容，而在存储桶里新增了一个新的删除标记。

![](https://main.qcloudimg.com/raw/d56c346b4c42ebf7b42b30e4c1969af0.png)

在已启用多版本的存储桶中，新增的删除标记将具有唯一的版本 ID。因此，在一个存储桶中，同一个对象可能有多个删除标记。要永久删除“删除标记”，必须在 DELETE Object versionId 请求中包含其版本 ID。
如下图所示，执行 DELETE Object versionId 请求永久删除“删除标记”。

![](https://main.qcloudimg.com/raw/f4a7c23b94a671151d69d443b8d4568b.png)

>**注意：**只有根账号可以永久删除“删除标记”。

永久删除“删除标记”的步骤：
1. 将 versionId 设置为要删除的删除标记的版本 ID。
2. 发送 DELETE Object versionId 请求。

#### 还原早期版本
多版本的其中一个价值主张是能够检索对象的早期版本，有两种方法可执行该操作：
1. 将对象的早期版本复制到同一存储桶中
复制的对象将成为该对象的当前版本，且所有对象版本都保留。
2. 永久删除对象的当前版本
当您删除当前对象版本时，实际上会将后一个版本转换为该对象的当前版本。


### 管理暂停多版本状态下的对象
暂停多版本时，存储桶中的现有对象不会更改。更改的是对象存储在以后的请求中处理对象的方式。
以下将介绍在已暂停多版本的存储桶中如何管理对象。


#### 添加对象

在存储桶上暂停多版本后，当用户执行 PUT、POST 或 COPY 操作时，对象存储 COS 自动将版本 ID 为 null 添加到存放到该存储桶中的对象。如下图所示：

![](https://main.qcloudimg.com/raw/9c555b3a3950561dc7a9e65f26f5930f.png)

如果存储桶中存在多版本的对象，则添加到存储桶的对象将成为当前版本，并且版本 ID 为 null。如下图所示：

![](https://main.qcloudimg.com/raw/d15c20eec6d22a3f9f025de9f12b290e.png)

如果存储桶中已存在空版本，则该空版本将被覆盖，原有的对象内容也会相应被替换，如下图所示：

![](https://main.qcloudimg.com/raw/a4ae94db99083e05cf6c3e8dd9b0a629.png)

#### 检索数据元版本
在已暂停多版本的存储桶上，用户发出 GET Object 请求将返回对象的当前版本。

#### 删除对象
如果暂停了多版本，执行 DELETE 请求有以下情况：
- 存储桶中存在空版本的对象，将删除其版本 ID 为 null 的对象

如下图所示，用户执行一般 DELETE 操作时，对象存储 COS 会为空版本的对象插入删除标记。

![](https://main.qcloudimg.com/raw/ab16f1600352d5b82bc402dba094ba41.png)

>**注意：**删除标记不存在内容，在删除标记替换空版本时，空版本原先的内容会丢失。

- 存储桶中没有空版本的对象，存储桶中会新添加一个删除标记

如下图所示，在存储桶不存在空版本的情况下，用户执行 DELETE 操作不会删除任何内容；对象存储仅插入删除标记。

![](https://main.qcloudimg.com/raw/b1ab2d0775ceb6c526e9d9baf82f270b.png)

即使是在已暂停版本控制的存储桶中，根账号也可以永久删除指定版本。
如下图所示，删除指定的对象版本将永久删除该对象。

![](https://main.qcloudimg.com/raw/663c9a5cc7655278792c83a96445cb25.png)

>**注意：**只有根账号可以删除指定的对象版本。
